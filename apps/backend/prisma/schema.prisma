// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

/// @seed = "npx ts-node --compiler-options {\"module\":\"CommonJS\"} prisma/seed.ts"

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String  @id @default(cuid())
  email           String  @unique
  name            String
  password        String?
  roleId          String? // Link to roles table instead of hardcoded string
  isEmailVerified Boolean @default(false)

  // Social login fields
  googleId   String? @unique
  facebookId String? @unique
  twitterId  String? @unique
  githubId   String? @unique
  linkedinId String? @unique
  provider   String? // 'google', 'facebook', 'twitter', 'github', 'linkedin', 'email'
  avatar     String? // Profile picture URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  verificationCodes VerificationCode[]
  passwordResets    PasswordReset[]
  reviews           Review[]
  favorites         Favorite[]
  ratings           Rating[]
  cart              Cart?
  orders            Order[]
  paymentHistory    PaymentHistory[]
  activities        Activity[]
  transactions      Transaction[]
  orderActivities   OrderActivity[]
  notifications     Notification[]     @relation("NotificationRecipient")

  // RBAC Relations
  role         Role?      @relation("UserRole", fields: [roleId], references: [id])
  userTeams    UserTeam[]
  createdRoles Role[]     @relation("RoleCreator")
  createdTeams Team[]     @relation("TeamCreator")

  @@map("users")
}

model Activity {
  id          String   @id @default(cuid())
  type        String // 'order', 'user', 'product', 'payment', 'revenue', 'system'
  title       String
  description String
  metadata    Json? // Additional data like order ID, user ID, etc.
  userId      String? // User who performed the action (if applicable)
  createdAt   DateTime @default(now())

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@map("activities")
}

model Notification {
  id          String  @id @default(cuid())
  type        String // 'order', 'user', 'product', 'payment', 'review', 'stock', 'system', 'security'
  category    String // 'info', 'success', 'warning', 'error', 'critical'
  title       String
  message     String
  actionUrl   String? // Link to related resource (e.g., /orders/123, /products/456)
  actionLabel String? // Label for action button (e.g., "View Order", "Review Product")

  // Targeting
  recipientId   String? // Specific admin user (null = broadcast to all admins)
  recipientRole String? // Target specific role (e.g., 'admin', 'superadmin')

  // Status
  isRead Boolean   @default(false)
  readAt DateTime?

  // Priority
  priority String @default("normal") // 'low', 'normal', 'high', 'urgent'

  // Metadata
  metadata Json? // Additional data (order details, user info, etc.)
  icon     String? // Icon identifier for UI

  // Related entities
  entityType String? // 'order', 'user', 'product', 'review', etc.
  entityId   String? // ID of the related entity

  // Expiration
  expiresAt DateTime? // Auto-archive after this date

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  recipient User? @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead])
  @@index([type, category])
  @@index([createdAt])
  @@index([priority])
  @@map("notifications")
}

// RBAC System Tables
model Resource {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "customer", "order", "product"
  displayName String // e.g., "Customer Management", "Order Management"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  roleResources RoleResource[]

  @@map("resources")
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "view", "create", "edit", "delete"
  displayName String // e.g., "View", "Create", "Edit", "Delete"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  roleResources RoleResource[]

  @@map("permissions")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "user", "admin", "superadmin"
  displayName String // e.g., "User", "Admin", "Super Admin"
  description String?
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  isActive    Boolean  @default(true)
  createdBy   String? // Made optional for system roles
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  // Relations
  creator       User?          @relation("RoleCreator", fields: [createdBy], references: [id])
  roleResources RoleResource[]
  teamRoles     TeamRole[]
  users         User[]         @relation("UserRole")

  @@map("roles")
}

model RoleResource {
  id           String   @id @default(cuid())
  roleId       String
  resourceId   String
  permissionId String
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  resource   Resource   @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, resourceId, permissionId])
  @@map("role_resources")
}

model Team {
  id          String   @id @default(cuid())
  name        String   @unique
  displayName String
  description String?
  isActive    Boolean  @default(true)
  createdBy   String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator   User       @relation("TeamCreator", fields: [createdBy], references: [id])
  userTeams UserTeam[]
  teamRoles TeamRole[]

  @@map("teams")
}

model UserTeam {
  id       String   @id @default(cuid())
  userId   String
  teamId   String
  joinedAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@map("user_teams")
}

model TeamRole {
  id        String   @id @default(cuid())
  teamId    String
  roleId    String
  createdAt DateTime @default(now())

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([teamId, roleId])
  @@map("team_roles")
}

model VerificationCode {
  id        String   @id @default(cuid())
  userId    String
  email     String
  code      String
  type      String // 'email_verification'
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("verification_codes")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  email     String
  token     String   @unique
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  iconFileId  String? // Reference to File model
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subcategories Subcategory[]
  products      Product[]
  iconFile      File?         @relation("CategoryIcon", fields: [iconFileId], references: [id])

  @@map("categories")
}

model Subcategory {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  iconFileId  String? // Reference to File model
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  category Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  products Product[]
  iconFile File?     @relation("SubcategoryIcon", fields: [iconFileId], references: [id])

  @@map("subcategories")
}

// Products - Base product information
model Product {
  id            String   @id @default(cuid())
  name          String
  description   String?
  sku           String?  @unique // Base SKU for the product
  isActive      Boolean  @default(true)
  isFeatured    Boolean  @default(false)
  sortOrder     Int      @default(0)
  categoryId    String?
  subcategoryId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  category       Category?        @relation(fields: [categoryId], references: [id])
  subcategory    Subcategory?     @relation(fields: [subcategoryId], references: [id])
  variants       ProductVariant[] // Product can have multiple variants
  images         ProductImage[] // Product-level images
  prices         Price[] // Product-level pricing
  stock          Stock[] // Product-level stock (one-to-many)
  reviews        Review[]
  ratings        Rating[]
  favorites      Favorite[]
  flashSaleItems FlashSaleItem[]
  cartItems      CartItem[] // Products in cart

  @@map("products")
}

// Product Variants - Different versions of a product (e.g., size, color, material)
model ProductVariant {
  id         String   @id @default(cuid())
  productId  String
  sku        String   @unique // Unique SKU for this variant
  name       String // Variant name (e.g., "Red - Large", "128GB - Black")
  attributes Json? // JSON object: { color: "Red", size: "Large", material: "Cotton" }
  isDefault  Boolean  @default(false) // Mark one variant as default
  isActive   Boolean  @default(true)
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product    Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  prices     Price[] // Each variant has its own pricing
  stock      Stock[] // Each variant can have multiple stock entries
  images     ProductImage[] // Each variant can have its own images
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@map("product_variants")
}

model Order {
  id                    String    @id @default(cuid())
  orderNumber           String    @unique @default(cuid()) // Human-readable order number
  userId                String?
  guestUserInfo         String? // JSON string for guest user info
  shippingAddress       String // JSON string for shipping address
  billingAddress        String // JSON string for billing address
  subtotal              Float
  shippingCost          Float
  tax                   Float
  total                 Float
  status                String    @default("pending") // pending, confirmed, processing, shipped, out_for_delivery, delivered, cancelled, refunded
  paymentStatus         String    @default("pending") // pending, paid, failed, refunded
  stripePaymentIntentId String?
  notes                 String?
  isGuestOrder          Boolean   @default(false) // Whether this is a guest order
  estimatedDelivery     DateTime? // Estimated delivery date
  actualDelivery        DateTime? // Actual delivery date
  trackingNumber        String? // Shipping tracking number
  carrier               String? // Shipping carrier (UPS, FedEx, etc.)
  priority              String    @default("normal") // normal, high, urgent
  tags                  String[] // Array of tags for categorization
  internalNotes         String? // Internal notes for admin use
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user           User?            @relation(fields: [userId], references: [id])
  items          OrderItem[]
  paymentHistory PaymentHistory[]
  transactions   Transaction[]
  activities     OrderActivity[]

  @@map("orders")
}

model OrderActivity {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  action          String // status_change, shipping_update, notes_update, etc.
  field           String? // which field was changed (status, trackingNumber, carrier, etc.)
  oldValue        String? // previous value
  newValue        String? // new value
  performedBy     String? // admin/user ID who performed the action
  performedByUser User?    @relation(fields: [performedBy], references: [id], onDelete: SetNull)
  metadata        Json? // additional data (JSON)
  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([performedBy])
  @@map("order_activities")
}

model PaymentHistory {
  id                    String   @id @default(cuid())
  orderId               String
  userId                String? // User who made the payment (null for guest orders)
  stripePaymentIntentId String
  amount                Float
  currency              String   @default("USD")
  status                String // succeeded, failed, pending, cancelled
  paymentMethod         String? // card, bank_transfer, etc.
  last4                 String? // Last 4 digits of card
  brand                 String? // Visa, Mastercard, etc.
  receiptUrl            String? // Stripe receipt URL
  failureReason         String? // Reason for failure if any
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id])

  @@map("payment_history")
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  variantId String // Links to product variant
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order   Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  variant ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("order_items")
}

model Price {
  id        String    @id @default(cuid())
  productId String? // Links to product (for product-level pricing)
  variantId String? // Links to product variant (for variant-level pricing)
  price     Decimal   @db.Decimal(10, 2)
  salePrice Decimal?  @db.Decimal(10, 2)
  currency  String    @default("USD")
  isActive  Boolean   @default(true)
  validFrom DateTime  @default(now())
  validTo   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("prices")
}

model Stock {
  id           String   @id @default(cuid())
  productId    String? // Links to product (for product-level stock)
  variantId    String? // Links to product variant (for variant-level stock)
  quantity     Int      @default(0)
  reserved     Int      @default(0)
  minThreshold Int      @default(5)
  maxThreshold Int?
  isInStock    Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@map("stock")
}

// Product Images - Can link to either product or variant
model ProductImage {
  id        String   @id @default(cuid())
  productId String? // Optional: for product-level images
  variantId String? // Optional: for variant-specific images
  fileId    String // Reference to File model
  altText   String?
  isPrimary Boolean  @default(false)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product?        @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)
  file    File            @relation("ProductImage", fields: [fileId], references: [id])

  @@map("product_images")
}

model Review {
  id         String   @id @default(cuid())
  productId  String
  userId     String
  title      String?
  content    String
  rating     Int // 1-5 stars
  isApproved Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@map("reviews")
}

model Rating {
  id        String   @id @default(cuid())
  productId String
  userId    String
  rating    Int // 1-5 stars
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@map("ratings")
}

model Favorite {
  id        String   @id @default(cuid())
  productId String
  userId    String
  createdAt DateTime @default(now())

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([productId, userId])
  @@map("favorites")
}

model FlashSale {
  id          String   @id @default(cuid())
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  isActive    Boolean  @default(true)
  discount    Int // Percentage discount
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  items FlashSaleItem[]

  @@map("flash_sales")
}

model FlashSaleItem {
  id            String   @id @default(cuid())
  flashSaleId   String
  productId     String
  salePrice     Decimal  @db.Decimal(10, 2)
  originalPrice Decimal  @db.Decimal(10, 2)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  flashSale FlashSale @relation(fields: [flashSaleId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([flashSaleId, productId])
  @@map("flash_sale_items")
}

model File {
  id           String   @id @default(cuid())
  originalName String
  publicId     String   @unique
  url          String
  secureUrl    String
  format       String
  bytes        Int
  width        Int?
  height       Int?
  type         String // image, video, document, audio, other
  status       String // uploading, processing, ready, error, deleted
  folder       String?
  tags         String[]
  metadata     Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  categoryIcons    Category[]     @relation("CategoryIcon")
  subcategoryIcons Subcategory[]  @relation("SubcategoryIcon")
  productImages    ProductImage[] @relation("ProductImage")

  @@map("files")
}

model Cart {
  id           String   @id @default(cuid())
  userId       String?  @unique
  totalItems   Int      @default(0)
  subtotal     Decimal  @default(0) @db.Decimal(10, 2)
  shippingCost Decimal  @default(0) @db.Decimal(10, 2)
  tax          Decimal  @default(0) @db.Decimal(10, 2)
  total        Decimal  @default(0) @db.Decimal(10, 2)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user  User?      @relation(fields: [userId], references: [id])
  items CartItem[]

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  variantId String?
  quantity  Int      @default(1)
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cart    Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([cartId, productId, variantId])
  @@map("cart_items")
}

model Transaction {
  id          String  @id @default(cuid())
  orderId     String? // Reference to the order that created this transaction
  userId      String? // User who made the transaction (null for guest orders)
  type        String // 'order_payment', 'refunded', 'partial_refund', 'fee', 'adjustment'
  status      String  @default("pending") // 'pending', 'completed', 'failed', 'cancelled', 'refunded'
  amount      Float // Transaction amount (positive for income, negative for expenses)
  currency    String  @default("USD")
  description String // Human-readable description
  reference   String? // External reference (e.g., Stripe payment intent ID)
  metadata    Json? // Additional transaction data (JSON)

  // Payment method information
  paymentMethod        String? // 'card', 'paypal', 'bank_transfer', etc.
  paymentMethodDetails Json? // Payment method specific details

  // Fee breakdown
  processingFee Float? // Processing fee amount
  platformFee   Float? // Platform fee amount
  netAmount     Float // Amount after fees (amount - processingFee - platformFee)

  // Timestamps
  processedAt DateTime? // When the transaction was processed
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)
  user  User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("transactions")
}
